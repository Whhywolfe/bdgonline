<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard - BDG GAME</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body { background:#121212; color:#fff; font-family:sans-serif; margin:0; }
    h2 { text-align:center; padding:10px; background:#1e1e1e; }
    .tabs { display:flex; justify-content:space-around; background:#1e1e1e; }
    .tab { padding:10px; cursor:pointer; }
    .tab.active { background:#ffdd57; color:#000; font-weight:bold; }
    .content { padding:15px; display:none; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th,td { padding:8px; border-bottom:1px solid #333; }
    input,select,button { padding:8px; margin:5px 0; border:none; border-radius:5px; }
    button { background:linear-gradient(to right,#ffdd57,#c7a100); cursor:pointer; font-weight:bold; }
  </style>
</head>
<body>
  <h2>BDG GAME Admin Dashboard</h2>

  <div class="tabs">
    <div class="tab active" onclick="showTab('payment')">Payment Settings</div>
    <div class="tab" onclick="showTab('deposits')">Deposits</div>
    <div class="tab" onclick="showTab('withdraws')">Withdrawals</div>
    <div class="tab" onclick="showTab('users')">Users</div>
    <div class="tab" onclick="showTab('game')">Game Control</div>
  </div>

  <!-- ✅ Payment Settings -->
  <div class="content" id="payment" style="display:block;">
    <h3>Payment Settings</h3>
    <input id="upi" placeholder="UPI ID"><br>
    <input id="bankName" placeholder="Bank Name"><br>
    <input id="accountNumber" placeholder="Account Number"><br>
    <input id="ifsc" placeholder="IFSC Code"><br>
    <button onclick="savePaymentSettings()">Save Payment Settings</button>
    <p id="payMsg"></p>
  </div>

  <!-- ✅ Deposit Requests -->
  <div class="content" id="deposits">
    <h3>Deposit Requests</h3>
    <table>
      <thead><tr><th>User</th><th>Amount</th><th>UTR</th><th>Status</th><th>Action</th></tr></thead>
      <tbody id="depositBody"></tbody>
    </table>
  </div>

  <!-- ✅ Withdraw Requests -->
  <div class="content" id="withdraws">
    <h3>Withdraw Requests</h3>
    <table>
      <thead><tr><th>User</th><th>Amount</th><th>Account</th><th>Status</th><th>Action</th></tr></thead>
      <tbody id="withdrawBody"></tbody>
    </table>
  </div>

  <!-- ✅ Users List -->
  <div class="content" id="users">
    <h3>Users List</h3>
    <table>
      <thead><tr><th>Name/UID</th><th>Wallet</th><th>Total Deposit</th><th>Total Withdraw</th></tr></thead>
      <tbody id="usersBody"></tbody>
    </table>
  </div>

  <!-- ✅ Game Control -->
  <div class="content" id="game">
    <h3>Game Control</h3>
    <label>Mode: </label>
    <select id="gameMode" onchange="updateGameMode()">
      <option value="auto">Auto</option>
      <option value="manual">Manual</option>
    </select>
    <div id="manualResultBox" style="margin-top:10px; display:none;">
      <input id="manualNumber" placeholder="Number (0-9)">
      <input id="manualColor" placeholder="Color (Red/Green/Violet)">
      <input id="manualSize" placeholder="Size (Big/Small)">
      <button onclick="setManualResult()">Save Manual Result</button>
    </div>
    <p id="gameMsg"></p>
  </div>

  <script>
    // ✅ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCBE6_qVOGSigbw-pLyHhLBVdV6rpvnfn0",
      authDomain: "bdggame-a9c98.firebaseapp.com",
      projectId: "bdggame-a9c98",
      storageBucket: "bdggame-a9c98.appspot.com",
      messagingSenderId: "79394469856",
      appId: "1:79394469856:web:72cec76208846251e01d85"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const rtdb = firebase.database();

    // ✅ Login Check
    if(localStorage.getItem("adminLoggedIn")!=="true"){ window.location.href="index.html"; }

    function showTab(id){
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.content').forEach(c=>c.style.display='none');
      document.querySelector(`.tab[onclick="showTab('${id}')"]`).classList.add('active');
      document.getElementById(id).style.display='block';
    }

    // ✅ Payment Settings Save
    function savePaymentSettings(){
      const data = {
        upi: document.getElementById('upi').value,
        bankName: document.getElementById('bankName').value,
        accountNumber: document.getElementById('accountNumber').value,
        ifsc: document.getElementById('ifsc').value
      };
      rtdb.ref("paymentSettings").set(data).then(()=>{
        document.getElementById('payMsg').innerText="Payment Settings Updated!";
      });
    }

    // ✅ Load Deposit Requests
    function loadDeposits(){
      db.collection("depositRequests").onSnapshot(snap=>{
        let html="";
        snap.forEach(doc=>{
          const d=doc.data();
          html+=`<tr>
            <td>${d.uid}</td>
            <td>₹${d.amount}</td>
            <td>${d.utr||'-'}</td>
            <td>${d.status}</td>
            <td>
              <button onclick="approveDeposit('${doc.id}','${d.uid}',${d.amount})">Approve</button>
              <button onclick="rejectDeposit('${doc.id}')">Reject</button>
            </td></tr>`;
        });
        document.getElementById('depositBody').innerHTML=html;
      });
    }

    function approveDeposit(reqId,uid,amount){
      // ✅ Update status + wallet
      db.collection("depositRequests").doc(reqId).update({status:"Approved"});
      db.collection("users").doc(uid).update({mainWallet:firebase.firestore.FieldValue.increment(amount)});
    }
    function rejectDeposit(reqId){ db.collection("depositRequests").doc(reqId).update({status:"Rejected"}); }

    // ✅ Load Withdraw Requests
    function loadWithdraws(){
      db.collection("withdrawRequests").onSnapshot(snap=>{
        let html="";
        snap.forEach(doc=>{
          const d=doc.data();
          html+=`<tr>
            <td>${d.uid}</td>
            <td>₹${d.amount}</td>
            <td>${d.accountNumber||'-'}</td>
            <td>${d.status}</td>
            <td>
              <button onclick="approveWithdraw('${doc.id}','${d.uid}',${d.amount})">Approve</button>
              <button onclick="rejectWithdraw('${doc.id}')">Reject</button>
            </td></tr>`;
        });
        document.getElementById('withdrawBody').innerHTML=html;
      });
    }

    function approveWithdraw(reqId,uid,amount){
      db.collection("withdrawRequests").doc(reqId).update({status:"Approved"});
      db.collection("users").doc(uid).update({mainWallet:firebase.firestore.FieldValue.increment(-amount)});
    }
    function rejectWithdraw(reqId){ db.collection("withdrawRequests").doc(reqId).update({status:"Rejected"}); }

    // ✅ Load Users
    function loadUsers(){
      db.collection("users").onSnapshot(snap=>{
        let html="";
        snap.forEach(doc=>{
          const d=doc.data();
          html+=`<tr>
            <td>${doc.id}</td>
            <td>₹${d.mainWallet||0}</td>
            <td>₹${d.totalDeposit||0}</td>
            <td>₹${d.totalWithdraw||0}</td>
          </tr>`;
        });
        document.getElementById('usersBody').innerHTML=html;
      });
    }

    // ✅ Game Control
    function updateGameMode(){
      const mode=document.getElementById('gameMode').value;
      rtdb.ref("gameControl").update({mode:mode});
      document.getElementById('manualResultBox').style.display = (mode==="manual")?"block":"none";
    }
    function setManualResult(){
      const num=document.getElementById('manualNumber').value;
      const col=document.getElementById('manualColor').value;
      const size=document.getElementById('manualSize').value;
      rtdb.ref("gameControl").update({
        nextResult:{number:num,color:col,size:size}
      });
      document.getElementById('gameMsg').innerText="Manual Result Saved!";
    }

    // ✅ Auto Load All
    loadDeposits();
    loadWithdraws();
    loadUsers();
  </script>
</body>
</html>
