<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard - BDG GAME</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body { background:#121212; color:#fff; font-family:sans-serif; margin:0; }
    h2 { text-align:center; padding:10px; background:#1e1e1e; }
    .tabs { display:flex; justify-content:space-around; background:#1e1e1e; }
    .tab { padding:10px; cursor:pointer; }
    .tab.active { background:#ffdd57; color:#000; font-weight:bold; }
    .content { padding:15px; display:none; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th,td { padding:8px; border-bottom:1px solid #333; }
    input,select,button { padding:8px; margin:5px 0; border:none; border-radius:5px; }
    button { background:linear-gradient(to right,#ffdd57,#c7a100); cursor:pointer; font-weight:bold; }
  </style>
</head>
<body>
  <h2>BDG GAME Admin Dashboard</h2>

  <div class="tabs">
    <div class="tab active" onclick="showTab('payment')">Payment Settings</div>
    <div class="tab" onclick="showTab('deposits')">Deposits</div>
    <div class="tab" onclick="showTab('withdraws')">Withdrawals</div>
    <div class="tab" onclick="showTab('users')">Users</div>
    <div class="tab" onclick="showTab('game')">Game Control</div>
  </div>

  <!-- ✅ Payment Settings -->
  <div class="content" id="payment" style="display:block;">
    <h3>Payment Settings</h3>
    <input id="upi" placeholder="UPI ID"><br>
    <input id="bankName" placeholder="Bank Name"><br>
    <input id="accountNumber" placeholder="Account Number"><br>
    <input id="ifsc" placeholder="IFSC Code"><br>
    <button onclick="savePaymentSettings()">Save Payment Settings</button>
    <p id="payMsg"></p>
  </div>

  <!-- ✅ Deposit Requests -->
  <div class="content" id="deposits">
    <h3>Deposit Requests</h3>
    <table>
      <thead><tr><th>User</th><th>Amount</th><th>UTR</th><th>Screenshot</th><th>Status</th><th>Action</th></tr></thead>
      <tbody id="depositBody"></tbody>
    </table>
  </div>

  <!-- ✅ Withdraw Requests -->
  <div class="content" id="withdraws">
    <h3>Withdraw Requests</h3>
    <table>
      <thead><tr><th>User</th><th>Amount</th><th>Account</th><th>Status</th><th>Action</th></tr></thead>
      <tbody id="withdrawBody"></tbody>
    </table>
  </div>

  <!-- ✅ Users List -->
  <div class="content" id="users">
    <h3>Users List</h3>
    <table>
      <thead><tr><th>UID</th><th>Wallet</th></tr></thead>
      <tbody id="usersBody"></tbody>
    </table>
  </div>

  <!-- ✅ Game Control -->
  <div class="content" id="game">
    <h3>Game Control</h3>
    <p>Current Period: <span id="currentPeriodText">Loading...</span></p>
    <label>Mode: </label>
    <select id="gameMode" onchange="updateGameMode()">
      <option value="auto">Auto</option>
      <option value="manual">Manual</option>
    </select>

    <!-- Manual Result Box -->
    <div id="manualResultBox" style="margin-top:15px; display:none;">
      <label>Choose Number (0–9):</label>
      <input id="manualNumber" placeholder="e.g. 5">
      <p>Detected Color: <strong id="autoColor">-</strong></p>
      <p>Detected Size: <strong id="autoSize">-</strong></p>
      <button onclick="publishManualResult()">✅ Publish Result</button>
    </div>
    <p id="gameMsg"></p>
  </div>

  <script>
    // ✅ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCNrrHD6S8540Rbd7iyqP1fPk6Wc7NpQCg",
      authDomain: "bdgonline-a20f8.firebaseapp.com",
      databaseURL: "https://bdgonline-a20f8-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "bdgonline-a20f8",
      storageBucket: "bdgonline-a20f8.appspot.com",
      messagingSenderId: "783742260288",
      appId: "1:783742260288:web:bc8de084be768dedee7ba5"
    };
    firebase.initializeApp(firebaseConfig);
    const rtdb = firebase.database();

    if(localStorage.getItem("adminLoggedIn")!=="true"){ window.location.href="index.html"; }

    function showTab(id){
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.content').forEach(c=>c.style.display='none');
      document.querySelector(`.tab[onclick="showTab('${id}')"]`).classList.add('active');
      document.getElementById(id).style.display='block';
    }

    // ✅ Save Payment Settings
    function savePaymentSettings(){
      const data = {
        upi: document.getElementById('upi').value,
        bankName: document.getElementById('bankName').value,
        accountNumber: document.getElementById('accountNumber').value,
        ifsc: document.getElementById('ifsc').value
      };
      rtdb.ref("paymentSettings").set(data).then(()=>{
        document.getElementById('payMsg').innerText="✅ Payment Settings Updated!";
      });
    }

    // ✅ Load Deposit Requests
    function loadDeposits(){
      rtdb.ref("depositRequests").on("value", snapshot=>{
        let html="";
        snapshot.forEach(child=>{
          const d = child.val();
          html+=`<tr>
            <td>${d.uid}</td>
            <td>₹${d.amount}</td>
            <td>${d.utr}</td>
            <td><a href="${d.screenshot}" target="_blank">View</a></td>
            <td>${d.status}</td>
            <td>
              <button onclick="approveDeposit('${child.key}','${d.uid}',${d.amount})">Approve</button>
              <button onclick="rejectDeposit('${child.key}')">Reject</button>
            </td></tr>`;
        });
        document.getElementById('depositBody').innerHTML=html;
      });
    }
    function approveDeposit(reqId, uid, amount){
      rtdb.ref(`depositRequests/${reqId}/status`).set("approved");
      rtdb.ref(`users/${uid}/balance`).transaction(bal => (bal||0) + amount);
    }
    function rejectDeposit(reqId){
      rtdb.ref(`depositRequests/${reqId}/status`).set("rejected");
    }

    // ✅ Load Withdraw Requests
    function loadWithdraws(){
      rtdb.ref("withdrawalRequests").on("value", snapshot=>{
        let html="";
        snapshot.forEach(child=>{
          const d = child.val();
          html+=`<tr>
            <td>${d.uid}</td>
            <td>₹${d.amount}</td>
            <td>${d.accountNumber}</td>
            <td>${d.status}</td>
            <td>
              <button onclick="approveWithdraw('${child.key}','${d.uid}',${d.amount})">Approve</button>
              <button onclick="rejectWithdraw('${child.key}')">Reject</button>
            </td></tr>`;
        });
        document.getElementById('withdrawBody').innerHTML=html;
      });
    }
    function approveWithdraw(reqId,uid,amount){
      rtdb.ref(`withdrawalRequests/${reqId}/status`).set("approved");
      rtdb.ref(`users/${uid}/balance`).transaction(bal => (bal||0) - amount);
    }
    function rejectWithdraw(reqId){
      rtdb.ref(`withdrawalRequests/${reqId}/status`).set("rejected");
    }

    // ✅ Load Users Wallet
    function loadUsers(){
      rtdb.ref("users").on("value", snapshot=>{
        let html="";
        snapshot.forEach(child=>{
          const d=child.val();
          html+=`<tr>
            <td>${child.key}</td>
            <td>₹${d.balance || 0}</td>
          </tr>`;
        });
        document.getElementById('usersBody').innerHTML=html;
      });
    }

    // ✅ GAME CONTROL MANUAL RESULT
    let currentPeriod = null;

    function loadCurrentPeriod(){
      rtdb.ref("globalGame/30s/currentPeriod").on("value",snap=>{
        currentPeriod = snap.val();
        document.getElementById("currentPeriodText").innerText = currentPeriod || "Not Started";
      });
    }

    // Detect Color & Size when typing number
    document.addEventListener("input", e=>{
      if(e.target.id === "manualNumber"){
        const num = parseInt(e.target.value);
        if(isNaN(num) || num<0 || num>9){
          document.getElementById("autoColor").innerText="-";
          document.getElementById("autoSize").innerText="-";
          return;
        }
        let color="", size="";
        if(num===0){ color="Violet"; size="Small"; }
        else if(num%2===0){ color="Red"; size=(num>=5?"Big":"Small"); }
        else{ color="Green"; size=(num>=5?"Big":"Small"); }

        document.getElementById("autoColor").innerText=color;
        document.getElementById("autoSize").innerText=size;
      }
    });

    async function publishManualResult(){
      if(!currentPeriod){ alert("Current period not loaded!"); return; }
      const num = parseInt(document.getElementById("manualNumber").value);
      if(isNaN(num) || num<0 || num>9){ alert("Enter valid number 0–9"); return; }

      let color="", size="";
      if(num===0){ color="Violet"; size="Small"; }
      else if(num%2===0){ color="Red"; size=(num>=5?"Big":"Small"); }
      else{ color="Green"; size=(num>=5?"Big":"Small"); }

      // Save result for currentPeriod
      await rtdb.ref(`results/30s/${currentPeriod}`).set({
        number: num,
        color: color,
        size: size,
        timestamp: Date.now()
      });

      // Next Period + Reset Timer
      const nextPeriod = "M" + Date.now();
      await rtdb.ref("globalGame/30s").set({
        currentPeriod: nextPeriod,
        remaining: 30
      });

      document.getElementById("gameMsg").innerText = `✅ Result Published: ${num} (${color}, ${size})`;
    }

    function updateGameMode(){
      const mode=document.getElementById('gameMode').value;
      rtdb.ref("gameControl").update({mode:mode});
      document.getElementById('manualResultBox').style.display = (mode==="manual")?"block":"none";
    }

    // ✅ Init
    loadDeposits();
    loadWithdraws();
    loadUsers();
    loadCurrentPeriod();
  </script>
</body>
</html>
